<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ZoneTrain - Choose Your Plan</title>
    <link rel="stylesheet" href="css/cookies.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', system-ui, sans-serif;
            background: linear-gradient(135deg, #6B46C1 0%, #8B5CF6 100%);
            min-height: 100vh;
            padding: 20px;
            color: #1F2937;
        }

        .back-btn {
            position: fixed;
            top: 20px;
            left: 20px;
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 10px 18px;
            background: rgba(255, 255, 255, 0.15);
            color: white;
            text-decoration: none;
            border-radius: 25px;
            font-size: 14px;
            font-weight: 600;
            backdrop-filter: blur(10px);
            transition: all 0.3s;
            z-index: 1000;
            border: none;
            cursor: pointer;
        }

        .back-btn:hover {
            background: rgba(255, 255, 255, 0.25);
            transform: translateX(-3px);
        }

        .container {
            max-width: 1000px;
            margin: 0 auto;
            padding-top: 20px;
        }

        .header {
            text-align: center;
            color: white;
            margin-bottom: 40px;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.2);
        }

        .header p {
            font-size: 1.1rem;
            opacity: 0.95;
        }

        .promo-box {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(15px);
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 30px;
            text-align: center;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .promo-box h3 {
            color: white;
            font-size: 1.2rem;
            margin-bottom: 15px;
        }

        .promo-inputs {
            display: flex;
            justify-content: center;
            gap: 10px;
            flex-wrap: wrap;
            margin-bottom: 10px;
        }

        .promo-input {
            padding: 12px 20px;
            border: 2px solid #A78BFA;
            border-radius: 25px;
            font-size: 1rem;
            text-align: center;
            background: white;
            color: #1F2937;
            font-weight: 500;
            text-transform: uppercase;
            min-width: 180px;
        }

        .promo-btn {
            padding: 12px 25px;
            background: #10B981;
            color: white;
            border: none;
            border-radius: 25px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .promo-btn:hover {
            background: #059669;
            transform: translateY(-2px);
        }

        .promo-msg {
            padding: 10px;
            border-radius: 10px;
            font-weight: 500;
            margin-top: 10px;
            display: none;
        }

        .promo-msg.success {
            background: rgba(16, 185, 129, 0.2);
            color: #10B981;
            border: 1px solid #10B981;
        }

        .promo-msg.error {
            background: rgba(239, 68, 68, 0.2);
            color: #EF4444;
            border: 1px solid #EF4444;
        }

        .promo-info {
            color: rgba(255, 255, 255, 0.8);
            font-size: 0.9rem;
            margin-top: 8px;
        }

        .cycle-selector {
            text-align: center;
            margin: 30px 0;
            display: flex;
            justify-content: center;
            gap: 15px;
            flex-wrap: wrap;
        }

        .cycle-btn {
            padding: 12px 24px;
            border: 2px solid #A78BFA;
            background: white;
            color: #1F2937;
            border-radius: 25px;
            font-weight: 600;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.3s;
        }

        .cycle-btn:hover {
            border-color: #8B5CF6;
            color: #8B5CF6;
        }

        .cycle-btn.active {
            background: #8B5CF6;
            color: white;
            border-color: #8B5CF6;
        }

        .plans {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 30px;
            margin-bottom: 40px;
        }

        .plan {
            background: white;
            border-radius: 15px;
            padding: 30px;
            text-align: center;
            position: relative;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            transition: transform 0.3s;
        }

        .plan:hover {
            transform: translateY(-5px);
        }

        .plan.featured {
            border: 3px solid #8B5CF6;
            transform: scale(1.05);
        }

        .plan.featured:hover {
            transform: scale(1.08) translateY(-5px);
        }

        .badge {
            position: absolute;
            top: -12px;
            left: 50%;
            transform: translateX(-50%);
            background: #F59E0B;
            color: white;
            padding: 6px 16px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: bold;
        }

        .plan-name {
            font-size: 1.8rem;
            color: #6B46C1;
            margin-bottom: 15px;
            font-weight: 600;
        }

        .price-box {
            margin: 15px 0;
        }

        .price-original {
            font-size: 1.5rem;
            color: #6B7280;
            text-decoration: line-through;
            margin-bottom: 5px;
            display: none;
        }

        .price {
            font-size: 2.5rem;
            font-weight: bold;
            color: #8B5CF6;
        }

        .period {
            color: #6B7280;
            font-size: 0.9rem;
            margin-top: 5px;
        }

        .savings {
            background: #10B981;
            color: white;
            padding: 8px 15px;
            border-radius: 10px;
            font-size: 0.9rem;
            margin: 10px 0;
            font-weight: 600;
            display: none;
        }

        .discount-label {
            background: #F59E0B;
            color: white;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 600;
            position: absolute;
            top: -8px;
            right: 20px;
            display: none;
        }

        .promise {
            background: linear-gradient(135deg, #A78BFA, rgba(167, 139, 250, 0.8));
            color: white;
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
            font-weight: 600;
        }

        .features {
            list-style: none;
            text-align: left;
            margin: 20px 0;
        }

        .features li {
            padding: 8px 0;
            padding-left: 25px;
            position: relative;
        }

        .features li::before {
            content: "‚úì";
            position: absolute;
            left: 0;
            color: #10B981;
            font-weight: bold;
            font-size: 1.2rem;
        }

        .trial {
            background: #10B981;
            color: white;
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 0.9rem;
            margin: 15px 0;
            display: inline-block;
        }

        .btns {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-top: 20px;
        }

        .btn {
            padding: 15px;
            border: none;
            border-radius: 8px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-trial {
            background: #6B46C1;
            color: white;
        }

        .btn-trial:hover {
            background: #8B5CF6;
            transform: translateY(-2px);
        }

        .btn-subscribe {
            background: #10B981;
            color: white;
        }

        .btn-subscribe:hover {
            background: #059669;
            transform: translateY(-2px);
        }

        .sep {
            text-align: center;
            color: #6B7280;
            font-size: 0.85rem;
            margin: 5px 0;
        }

        .payment-info {
            background: rgba(255, 255, 255, 0.1);
            color: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            margin: 30px 0;
        }

        .payment-methods {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-top: 15px;
            flex-wrap: wrap;
        }

        .pm {
            background: white;
            color: #1F2937;
            padding: 6px 12px;
            border-radius: 5px;
            font-size: 0.85rem;
            font-weight: 600;
        }

        .guarantee {
            background: rgba(255, 255, 255, 0.1);
            color: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
        }

        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(5px);
            z-index: 10000;
            display: none;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .modal.active {
            display: flex;
        }

        .modal-box {
            background: linear-gradient(135deg, #6B46C1, #8B5CF6);
            border-radius: 20px;
            padding: 30px;
            color: white;
            max-width: 450px;
            text-align: center;
        }

        .modal-btns {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }

        @media (max-width: 768px) {
            .plan.featured {
                transform: none;
            }
            .plans {
                grid-template-columns: 1fr;
            }
            .header h1 {
                font-size: 2rem;
            }
            .back-btn {
                top: 15px;
                left: 15px;
                padding: 8px 14px;
                font-size: 13px;
            }
        }
    </style>
</head>
<body>
    <button class="back-btn" id="backBtn">
        <svg width="18" height="18" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/>
        </svg>
        Back
    </button>

    <div class="container">
        <div class="header">
            <h1>üèÉ‚Äç‚ôÇÔ∏è Choose Your Training Plan</h1>
            <p>Personalized training plans tailored to your HRV and fitness goals</p>
        </div>

        <div class="promo-box">
            <h3>üéâ Have a Promo Code?</h3>
            <div class="promo-inputs">
                <input type="text" id="promoInput" class="promo-input" placeholder="Enter code" maxlength="20">
                <button class="promo-btn" id="applyPromoBtn">Apply Code</button>
            </div>
            <div id="promoMsg" class="promo-msg"></div>
            <p class="promo-info">Launch special: Use code LAUNCH50 for 50% off!</p>
        </div>

        <div class="cycle-selector">
            <button class="cycle-btn active" data-cycle="monthly">üìÖ Monthly</button>
            <button class="cycle-btn" data-cycle="quarterly">
                üìä Quarterly<br><small style="font-size:0.8rem;opacity:0.9">Save 10%</small>
            </button>
            <button class="cycle-btn" data-cycle="annual">
                üìà Annual<br><small style="font-size:0.8rem;opacity:0.9">Save 20%</small>
            </button>
        </div>

        <div class="plans">
            <!-- Fitness Plan -->
            <div class="plan">
                <div class="plan-name">Fitness Coach</div>
                <div class="price-box">
                    <div class="price-original" id="fit-orig">‚Çπ199</div>
                    <div class="price" id="fit-price">‚Çπ199</div>
                    <div class="discount-label" id="fit-disc">50% OFF</div>
                    <div class="period" id="fit-period">per month</div>
                </div>
                <div class="savings" id="fit-save">Save ‚Çπ60</div>
                <div class="promise">Build running fitness and consistency</div>
                <ul class="features">
                    <li>Progressive running plans for beginners/maintainers</li>
                    <li>Habit formation (3x/week running routine)</li>
                    <li>Basic performance improvement</li>
                    <li>HRV-based daily adjustments</li>
                    <li>WhatsApp coaching integration</li>
                </ul>
                <div class="trial">14 Days Free Trial</div>
                <div class="btns">
                    <button class="btn btn-trial" data-plan="fitness" data-action="trial">üÜì Start Free Trial</button>
                    <div class="sep">or</div>
                    <button class="btn btn-subscribe" data-plan="fitness" data-action="subscribe">Subscribe Now</button>
                </div>
            </div>

            <!-- Race Plan -->
            <div class="plan featured">
                <div class="badge">‚≠ê Most Popular</div>
                <div class="plan-name">Race Coach</div>
                <div class="price-box">
                    <div class="price-original" id="race-orig">‚Çπ399</div>
                    <div class="price" id="race-price">‚Çπ399</div>
                    <div class="discount-label" id="race-disc">50% OFF</div>
                    <div class="period" id="race-period">per month</div>
                </div>
                <div class="savings" id="race-save">Save ‚Çπ120</div>
                <div class="promise">Train effectively for specific race goals</div>
                <ul class="features">
                    <li>Everything in Fitness Coach</li>
                    <li>Periodization for target races</li>
                    <li>Performance optimization</li>
                    <li>Training load management</li>
                    <li>Race strategy planning</li>
                    <li>Advanced analytics dashboard</li>
                </ul>
                <div class="trial">14 Days Free Trial</div>
                <div class="btns">
                    <button class="btn btn-trial" data-plan="race" data-action="trial">üÜì Start Free Trial</button>
                    <div class="sep">or</div>
                    <button class="btn btn-subscribe" data-plan="race" data-action="subscribe">Subscribe Now</button>
                </div>
            </div>
        </div>

        <div class="payment-info">
            <h4>üí≥ Secure Payment Options</h4>
            <div class="payment-methods">
                <div class="pm">üí≥ Card</div>
                <div class="pm">üè¶ UPI</div>
                <div class="pm">üè™ Net Banking</div>
                <div class="pm">üì± Wallets</div>
            </div>
            <p style="margin-top: 15px; font-size: 0.85rem; opacity: 0.9;">
                Powered by Razorpay ‚Ä¢ SSL Secured ‚Ä¢ Cancel Anytime
            </p>
        </div>

        <div class="guarantee">
            <p>Try any plan risk-free. If you're not satisfied, you can cancel your subscription at any time.</p>
        </div>
    </div>

    <!-- Cookie Banner -->
    <div id="ztCookieBanner" class="zt-cookie-banner">
        <div class="zt-cookie-container">
            <div class="zt-cookie-content">
                <div class="zt-cookie-title">üç™ Cookie Preferences</div>
                <div class="zt-cookie-text">Update your cookie preferences to enhance your ZoneTrain experience.</div>
            </div>
            <div class="zt-cookie-actions">
                <button class="zt-cookie-btn zt-cookie-settings" onclick="ztCookies.showSettings()">Settings</button>
                <button class="zt-cookie-btn zt-cookie-accept" onclick="ztCookies.acceptAll()">Accept All</button>
            </div>
        </div>
    </div>

    <script src="https://checkout.razorpay.com/v1/checkout.js"></script>
    <script src="/js/payment.js"></script>
    <script src="js/cookies.js"></script>
    
    <script>
        // DATA
        const PRICES = {
            fitness: { monthly: 199, quarterly: 537, annual: 1913 },
            race: { monthly: 399, quarterly: 1077, annual: 3830 }
        };

        const PERIODS = {
            monthly: 'per month',
            quarterly: 'per quarter',
            annual: 'per year'
        };

        const SAVINGS = {
            fitness: { monthly: 0, quarterly: 60, annual: 475 },
            race: { monthly: 0, quarterly: 120, annual: 958 }
        };

        let currentCycle = 'monthly';
        let promoActive = false;

        // BACK BUTTON
        document.getElementById('backBtn').addEventListener('click', () => {
            const token = localStorage.getItem('userToken');
            if (document.referrer && document.referrer.includes(window.location.host)) {
                window.history.back();
            } else if (token) {
                window.location.href = '/dashboard';
            } else {
                window.location.href = '/';
            }
        });

        // PROMO CODE
        document.getElementById('applyPromoBtn').addEventListener('click', () => {
            const input = document.getElementById('promoInput');
            const code = input.value.trim().toUpperCase();
            const msg = document.getElementById('promoMsg');
            
            if (!code) {
                msg.textContent = '‚ö†Ô∏è Please enter a code';
                msg.className = 'promo-msg error';
                msg.style.display = 'block';
                setTimeout(() => msg.style.display = 'none', 3000);
                return;
            }
            
            const valid = ['LAUNCH50', 'EARLY50', 'RUNNER50'];
            
            if (valid.includes(code)) {
                promoActive = true;
                sessionStorage.setItem('promoCode', code);
                sessionStorage.setItem('promoApplied', 'true');
                
                msg.textContent = `‚úÖ ${code} applied! 50% OFF`;
                msg.className = 'promo-msg success';
                msg.style.display = 'block';
                
                document.getElementById('fit-orig').style.display = 'block';
                document.getElementById('fit-disc').style.display = 'block';
                document.getElementById('race-orig').style.display = 'block';
                document.getElementById('race-disc').style.display = 'block';
                
                updatePrices();
            } else {
                promoActive = false;
                msg.textContent = '‚ùå Invalid code. Try LAUNCH50';
                msg.className = 'promo-msg error';
                msg.style.display = 'block';
                setTimeout(() => msg.style.display = 'none', 3000);
                
                document.getElementById('fit-orig').style.display = 'none';
                document.getElementById('fit-disc').style.display = 'none';
                document.getElementById('race-orig').style.display = 'none';
                document.getElementById('race-disc').style.display = 'none';
                
                updatePrices();
            }
        });

        document.getElementById('promoInput').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') document.getElementById('applyPromoBtn').click();
        });

        // CYCLE SELECTOR
        document.querySelectorAll('.cycle-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                document.querySelectorAll('.cycle-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                currentCycle = btn.dataset.cycle;
                updatePrices();
            });
        });

        // UPDATE PRICES
        function updatePrices() {
            const fitPrice = PRICES.fitness[currentCycle];
            const racePrice = PRICES.race[currentCycle];
            const period = PERIODS[currentCycle];
            
            let fitFinal = Math.floor(fitPrice);
            let raceFinal = Math.floor(racePrice);
            
            if (promoActive) {
                fitFinal = Math.floor(fitPrice * 0.5);
                raceFinal = Math.floor(racePrice * 0.5);
            }
            
            document.getElementById('fit-price').textContent = '‚Çπ' + fitFinal;
            document.getElementById('race-price').textContent = '‚Çπ' + raceFinal;
            
            document.getElementById('fit-period').textContent = period;
            document.getElementById('race-period').textContent = period;
            
            document.getElementById('fit-orig').textContent = '‚Çπ' + Math.floor(fitPrice);
            document.getElementById('race-orig').textContent = '‚Çπ' + Math.floor(racePrice);
            
            const fitSave = SAVINGS.fitness[currentCycle];
            const raceSave = SAVINGS.race[currentCycle];
            
            if (currentCycle === 'monthly') {
                document.getElementById('fit-save').style.display = 'none';
                document.getElementById('race-save').style.display = 'none';
            } else {
                const pct = currentCycle === 'quarterly' ? '10%' : '20%';
                document.getElementById('fit-save').textContent = `Save ‚Çπ${fitSave} (${pct} off)`;
                document.getElementById('fit-save').style.display = 'block';
                document.getElementById('race-save').textContent = `Save ‚Çπ${raceSave} (${pct} off)`;
                document.getElementById('race-save').style.display = 'block';
            }
        }

        // PLAN SELECTION
        document.querySelectorAll('.btn').forEach(btn => {
            btn.addEventListener('click', () => {
                const plan = btn.dataset.plan;
                const action = btn.dataset.action;
                
                if (!plan || !action) return;
                
                const token = localStorage.getItem('userToken');
                
                if (!token) {
                    showLoginModal(plan, action);
                    return;
                }
                
                if (action === 'trial') {
                    startTrial(plan, btn);
                } else if (action === 'subscribe') {
                    purchase(plan);
                }
            });
        });

        // START TRIAL
        async function startTrial(plan, btn) {
            const orig = btn.textContent;
            btn.textContent = '‚è≥ Activating...';
            btn.disabled = true;
            
           try {
        const token = localStorage.getItem('userToken');
        
        // Map frontend plan names to backend plan types
        const planType = plan === 'fitness' ? 'basic' : 'race'; // ‚úÖ FIX
        
        const res = await fetch('/api/subscription/start-trial', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${token}`
            },
            body: JSON.stringify({ planType: planType }) // ‚úÖ Now sends "basic" or "race"
        });
                
                const data = await res.json();
                
                if (data.success) {
                    const msg = document.getElementById('promoMsg');
                    msg.textContent = '‚úÖ Trial activated!';
                    msg.className = 'promo-msg success';
                    msg.style.display = 'block';
                    
                    setTimeout(() => {
                        const p = plan === 'fitness' ? 'basic' : 'race';
                        window.location.href = `/ai-onboarding?plan=${p}`;
                    }, 1500);
                } else {
                    throw new Error(data.message);
                }
            } catch (err) {
                const msg = document.getElementById('promoMsg');
                msg.textContent = '‚ùå ' + err.message;
                msg.className = 'promo-msg error';
                msg.style.display = 'block';
                btn.textContent = orig;
                btn.disabled = false;
            }
        }

        // PURCHASE
        async function purchase(plan) {
            const promo = sessionStorage.getItem('promoCode');
            const price = PRICES[plan][currentCycle];
            const amount = promoActive ? Math.floor(price * 0.5): Math.floor(price);
            
            if (typeof window.purchaseSubscriptionWithPromo === 'function') {
                await window.purchaseSubscriptionWithPromo(plan, currentCycle, amount, promo);
            } else {
                alert('Payment system loading. Please refresh.');
            }
        }

        // LOGIN MODAL
        function showLoginModal(plan, action) {
            sessionStorage.setItem('planIntent', JSON.stringify({ planType: plan, actionType: action }));
            
            const modal = document.createElement('div');
            modal.className = 'modal active';
            modal.innerHTML = `
                <div class="modal-box">
                    <h2 style="margin-bottom: 20px;">üîê Account Required</h2>
                    <p style="margin-bottom: 20px;">Please log in or create an account to continue.</p>
                    <div class="modal-btns">
                        <button class="btn" style="flex:1;background:#A78BFA;" onclick="this.closest('.modal').remove()">Cancel</button>
                        <button class="btn" style="flex:1;background:#8B5CF6;" onclick="window.location.href='/login?redirect=plans'">Log In</button>
                        <button class="btn" style="flex:1;background:#6B46C1;" onclick="window.location.href='/signup?redirect=plans'">Sign Up</button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        // INIT
        const savedPromo = sessionStorage.getItem('promoApplied');
        if (savedPromo === 'true') {
            const code = sessionStorage.getItem('promoCode');
            if (code) {
                promoActive = true;
                document.getElementById('promoInput').value = code;
                document.getElementById('fit-orig').style.display = 'block';
                document.getElementById('fit-disc').style.display = 'block';
                document.getElementById('race-orig').style.display = 'block';
                document.getElementById('race-disc').style.display = 'block';
                updatePrices();
                const msg = document.getElementById('promoMsg');
                msg.textContent = `‚úÖ ${code} applied!`;
                msg.className = 'promo-msg success';
                msg.style.display = 'block';
            }
        }

        // CHECK PLAN INTENT
        const intent = sessionStorage.getItem('planIntent');
        if (intent) {
            const { planType, actionType } = JSON.parse(intent);
            sessionStorage.removeItem('planIntent');
            setTimeout(() => {
                const btn = document.querySelector(`[data-plan="${planType}"][data-action="${actionType}"]`);
                if (btn) btn.click();
            }, 500);
        }

        console.log('‚úÖ Plans page ready');

        async function initTrialButtons() {
  const token = localStorage.getItem('userToken');
  if (!token) return; // guests already get login modal

  try {
    const res = await fetch('/api/subscription/trial-eligibility', {
      headers: { 'Authorization': `Bearer ${token}` }
    });
    if (!res.ok) return;
    const data = await res.json();

    // If already on any trial/subscription, hide *all* trial buttons
    if (data.subscriptionStatus === 'trial' || data.subscriptionStatus === 'active') {
      document.querySelectorAll('.btn-trial').forEach(btn => {
        btn.style.display = 'none';
      });
      return;
    }

    // Otherwise, you can optionally hide per‚Äëplan buttons if trialUsed is true
    if (data.eligibility) {
      if (data.eligibility.basic && !data.eligibility.basic.eligible) {
        document
          .querySelectorAll('.btn-trial[data-plan="fitness"]')
          .forEach(btn => (btn.style.display = 'none'));
      }
      if (data.eligibility.race && !data.eligibility.race.eligible) {
        document
          .querySelectorAll('.btn-trial[data-plan="race"]')
          .forEach(btn => (btn.style.display = 'none'));
      }
    }
  } catch (e) {
    console.warn('Failed to load trial eligibility', e);
  }
}

initTrialButtons();

    </script>
</body>
</html>

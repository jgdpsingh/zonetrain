<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Race Coach - ZoneTrain</title>
    <link rel="stylesheet" href="/css/widgets.css">
    <link rel="stylesheet" href="/css/calendar.css">
    <script src="https://checkout.razorpay.com/v1/checkout.js"></script>
    <script src="/js/payment.js"></script>
    <style>
        :root { --primary: #4f46e5; --bg: #f3f4f6; }
        body { font-family: -apple-system, system-ui, sans-serif; background: var(--bg); margin: 0; padding-top: 80px; color: #1f2937; }
        
        .dashboard-container { max-width: 1200px; margin: 0 auto; padding: 20px; }
        
        /* Layouts */
        .dashboard-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; }
        .dashboard-title h1 { font-size: 24px; font-weight: 800; margin: 0; color: #111827; }
        .dashboard-title p { margin: 4px 0 0 0; color: #6b7280; font-size: 14px; }
        
        .race-hub-btn { 
            background: #fff; border: 1px solid #e5e7eb; padding: 10px 16px; 
            border-radius: 8px; font-weight: 600; color: #374151; cursor: pointer;
            display: flex; align-items: center; gap: 8px; box-shadow: 0 1px 2px rgba(0,0,0,0.05);
        }
        .race-hub-btn:hover { background: #f9fafb; border-color: #d1d5db; }

        /* Grids */
        .execution-grid { display: grid; grid-template-columns: 1.4fr 1fr; gap: 20px; margin-bottom: 20px; }
        .admin-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 20px;}

        /* Widget Containers */
        .widget { background: white; border-radius: 16px; border: 1px solid #e5e7eb; overflow: hidden; height: 100%; }
        .widget-header { padding: 15px 20px; border-bottom: 1px solid #f3f4f6; }
        .widget-header h3 { margin: 0; font-size: 16px; color: #1f2937; font-weight: 700; }
        
        @media (max-width: 900px) { .execution-grid, .admin-grid { grid-template-columns: 1fr; } }
    </style>
</head>
<body>

    <div id="nav-container"></div>

    <div class="dashboard-container">
        <div class="dashboard-header">
            <div class="dashboard-title">
                <h1>Race Execution</h1>
                <p id="race-countdown-text">Loading plan...</p>
            </div>
            <button onclick="window.dashboardWidgets.openRaceHub()" class="race-hub-btn">
                <span>üìä</span> Race Hub
            </button>
        </div>

        <div id="post-race-banner" style="display: none; background: linear-gradient(135deg, #10b981 0%, #059669 100%); padding: 20px; border-radius: 12px; margin-bottom: 20px; color: white; display:flex; justify-content:space-between; align-items:center;">
            <div>
                <h2 style="margin:0; font-size:18px;">üèÅ Race Complete!</h2>
                <p style="margin:5px 0 0 0; font-size:14px; opacity:0.9;">Ready for the next challenge?</p>
            </div>
            <button onclick="document.getElementById('new-race-modal').style.display='block'" style="background:white; color:#059669; border:none; padding:8px 16px; border-radius:6px; font-weight:700; cursor:pointer;">Set New Goal</button>
        </div>

        <div class="execution-grid">
            <div id="today-workout-container" class="widget" style="min-height: 280px; border:none; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);"></div>
            <div style="display: flex; flex-direction: column; gap: 20px;">
                <div id="ai-insight-widget-container"></div>
                <div id="readiness-chart-container" class="widget" style="flex:1;"></div>
            </div>
        </div>

        <div id="weekly-plan-container"></div>

        <div class="admin-grid">
            <div id="race-planning-container" class="widget"></div>
            <div id="subscription-controls-container" class="widget"></div>
        </div>
    </div>

    <div id="raceHubModal" style="display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 2000; align-items: center; justify-content: center;">
        <div style="background: white; width: 90%; max-width: 900px; height: 90vh; border-radius: 16px; overflow: hidden; display: flex; flex-direction: column;">
            <div style="padding: 20px; border-bottom: 1px solid #e5e7eb; display: flex; justify-content: space-between;">
                <h2 style="margin:0; font-size: 18px;">üìä Race Hub</h2>
                <button onclick="document.getElementById('raceHubModal').style.display='none'" style="border:none; background:none; font-size:24px; cursor:pointer;">&times;</button>
            </div>
            <div style="padding: 20px; overflow-y: auto; background: #f9fafb; display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                <div id="hub-pace-trend" class="widget"></div>
                <div id="hub-volume-trend" class="widget"></div>
                <div id="hub-personal-records" class="widget"></div>
                <div id="hub-history-list" class="widget" style="grid-column: span 2;"></div>
            </div>
        </div>
    </div>

    <div id="planManagementModal" style="display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 3000; align-items: center; justify-content: center;">
        <div style="background: white; width: 90%; max-width: 500px; border-radius: 12px; padding: 25px;">
            <h3 id="pm-title" style="margin-top:0;">Manage Plan</h3>
            <div id="pm-content"></div>
            <div style="margin-top: 20px; display: flex; justify-content: flex-end; gap: 10px;">
                <button onclick="document.getElementById('planManagementModal').style.display='none'" style="padding: 8px 16px; border-radius: 6px; border: 1px solid #ddd; background: white; cursor: pointer;">Cancel</button>
                <button id="pm-confirm-btn" style="padding: 8px 16px; border-radius: 6px; border: none; background: #ef4444; color: white; font-weight: 600; cursor: pointer;">Confirm</button>
            </div>
        </div>
    </div>

    <div id="questionModal" style="display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 3000; align-items: center; justify-content: center;">
        <div style="background: white; width: 90%; max-width: 450px; border-radius: 16px; overflow: hidden;">
            <div style="padding: 20px; background: #eff6ff; border-bottom: 1px solid #bfdbfe;">
                <h3 style="margin:0; color:#1e40af;">üí¨ Ask a Coach</h3>
            </div>
            <div style="padding: 20px;">
                <textarea id="raceQuestionInput" placeholder="How should I pace the first 5km?" style="width: 100%; height: 100px; padding: 10px; border: 1px solid #ddd; border-radius: 8px;"></textarea>
                <div id="questionStatus" style="margin-top:10px; font-size:13px;"></div>
                <div style="margin-top: 15px; text-align: right; display: flex; gap: 10px; justify-content: flex-end;">
                    <button onclick="document.getElementById('questionModal').style.display='none'" style="padding: 8px 16px; background: #f3f4f6; border: none; border-radius: 6px; cursor: pointer;">Cancel</button>
                    <button onclick="window.dashboardWidgets.submitRaceQuestion()" style="padding: 8px 16px; background: #1e40af; color: white; border: none; border-radius: 6px; cursor: pointer;">Send</button>
                </div>
            </div>
        </div>
    </div>

    <div id="nutritionModal" style="display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 3000; align-items: center; justify-content: center;">
        <div style="background: white; width: 90%; max-width: 500px; border-radius: 16px; overflow: hidden;">
            <div style="padding: 20px; background: #fff7ed; border-bottom: 1px solid #fed7aa; display:flex; justify-content:space-between;">
                <h3 style="margin:0; color:#9a3412;">üçå Nutrition Strategy</h3>
                <button onclick="document.getElementById('nutritionModal').style.display='none'" style="border:none; background:none; font-size:20px; cursor:pointer;">&times;</button>
            </div>
            <div id="nutritionContent" style="padding: 20px; max-height: 60vh; overflow-y: auto;"></div>
        </div>
    </div>

    <div id="new-race-modal" style="display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.8); z-index: 4000; align-items: center; justify-content: center;">
        <div style="background: white; width: 90%; max-width: 500px; border-radius: 16px; padding: 25px;">
            <h2 style="margin-top:0;">üéØ Race Goal</h2>
            <form id="new-race-form">
                <label style="display:block; margin-top:10px; font-weight:600;">Distance</label>
                <select id="new-race-distance" style="width:100%; padding:10px; margin-top:5px; border-radius:6px; border:1px solid #ddd;">
                    <option value="5">5K</option>
                    <option value="10">10K</option>
                    <option value="21.1">Half Marathon</option>
                    <option value="42.2">Marathon</option>
                </select>
                
                <label style="display:block; margin-top:10px; font-weight:600;">Race Date</label>
                <input type="date" id="new-race-date" style="width:100%; padding:10px; margin-top:5px; border-radius:6px; border:1px solid #ddd;" required>

                <div style="margin-top:20px; display:flex; justify-content:flex-end; gap:10px;">
                    <button type="button" onclick="document.getElementById('new-race-modal').style.display='none'" style="padding:10px 20px; border:1px solid #ddd; background:white; border-radius:6px; cursor:pointer;">Cancel</button>
                    <button type="submit" style="padding:10px 20px; background:#4f46e5; color:white; border:none; border-radius:6px; cursor:pointer;">Generate Plan</button>
                </div>
            </form>
        </div>
    </div>

    <script src="/firebase-config.js"></script>
    <script src="/components/nav-header.js"></script>
    <script src="/components/dashboard-race-widgets.js"></script>
    <script>
        // AUTH CHECK
        (function() {
            let token = localStorage.getItem('userToken');
            if (!token) {
                 window.location.href = '/login'; 
            } else {
                // Initial Load
                document.addEventListener('DOMContentLoaded', () => {
                    new NavHeader().render('nav-container');
                    window.dashboardWidgets = new RaceDashboardWidgets();
                    window.dashboardWidgets.init();
                });
            }
        })();

        // Form Handler for New Race (Restored from your old code but simplified)
        document.getElementById('new-race-form').addEventListener('submit', async function(e) {
            e.preventDefault();
            const token = localStorage.getItem('userToken');
            const submitBtn = e.target.querySelector('button[type="submit"]');
            submitBtn.textContent = "Processing...";
            submitBtn.disabled = true;

            const mode = document.getElementById('new-race-modal').dataset.mode || 'create';
            const url = mode === 'update' ? '/api/race-goals/update' : '/api/race/create';

            try {
                await fetch(url, {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        distance: parseFloat(document.getElementById('new-race-distance').value),
                        date: document.getElementById('new-race-date').value
                    })
                });
                alert("Plan updated successfully!");
                window.location.reload();
            } catch(e) {
                alert("Error: " + e.message);
                submitBtn.disabled = false;
            }
        });
    </script>
</body>
</html>